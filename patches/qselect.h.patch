diff --git a/src/qselect.h b/src/qselect.h
new file mode 100644
index 0000000..7c70070
--- /dev/null
+++ b/src/qselect.h
@@ -0,0 +1,71 @@
+#ifndef QSELECT_H
+#define QSELECT_H
+
+#include <stddef.h>
+
+typedef int(*__compare_fn_t)(const void*, const void*, void*);
+
+static inline void
+_qselect_memswap(void *restrict p1, void *restrict p2, size_t n)
+{
+  while (n > 0)
+    {
+      unsigned char t = ((unsigned char *)p1)[--n];
+      ((unsigned char *)p1)[n] = ((unsigned char *)p2)[n];
+      ((unsigned char *)p2)[n] = t;
+    }
+}
+
+static size_t 
+_qselect_partition(void* base, size_t size, size_t left, size_t right, size_t pivot_index, __compare_fn_t compare, void* arg)
+{
+	size_t store_index = left;
+	_qselect_memswap(base+right*size, base+pivot_index*size, size);
+	for(size_t i=left; i<right; i++)
+	{
+		if (compare(base+i*size, base+right*size, arg) <= 0)
+		{
+			_qselect_memswap(base+i*size, base+store_index*size, size);
+			store_index += 1; 
+		}
+	}
+	_qselect_memswap(base+store_index*size, base+right*size, size);
+	return store_index;
+}
+
+static size_t 
+_qselect_median3(void* base, size_t size, size_t left, size_t right, __compare_fn_t compare, void* arg)
+{
+	size_t mid = (left + right + 1) / 2;
+	if ((compare(base+left*size, base+mid*size, arg) > 0) != (compare(base+left*size, base+right*size, arg) > 0))
+		return left;
+	else if ((compare(base+mid*size, base+left*size, arg) < 0) != (compare(base+mid*size, base+right*size, arg) < 0))
+		return mid;
+	else
+		return right;
+}
+
+static size_t 
+qselect_r(void* base, size_t n, size_t size, size_t k, __compare_fn_t compare, void* arg) 
+{
+	size_t pivot_index;
+	size_t left = 0;
+	size_t right = n-1;
+
+	while(1) {
+		if (left == right)
+			return left;
+
+		pivot_index = _qselect_median3(base, size, left, right, compare, arg); 
+		pivot_index = _qselect_partition(base, size, left, right, pivot_index, compare, arg);
+
+		if(pivot_index == k) 
+			return pivot_index;
+		else if (k < pivot_index)
+			right = pivot_index - 1;
+		else
+			left = pivot_index + 1;
+	}
+}
+
+#endif
\ No newline at end of file
